{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ panorama.title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        #panorama-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000;
        }

        .custom-hotspot {
            width: 24px;
            height: 24px;
            background: rgba(255, 80, 80, 0.9);
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-hotspot:hover {
            background: rgba(80, 255, 144, 0.9);
            transform: scale(1.3);
        }

        .hotspot-tooltip {
            max-width: 280px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .hotspot-tooltip h3 {
            color: #4fc3f7;
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .hotspot-tooltip img {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 10px;
        }

        .hotspot-link {
            color: #4fc3f7 !important;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        #back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-weight: bold;
            display: none; /* Скрываем по умолчанию */
        }

        #back-button:hover {
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <div id="panorama-container"></div>
    <button id="back-button">← Назад</button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let viewer = null;
            
            const scenes = {
                "main": {
                    "type": "equirectangular",
                    "panorama": "{{ panorama.image.url }}",
                    "autoLoad": true,
                    "showControls": true,
                    "compass": true,
                    "haov": {{ panorama.haov }},
                    "vaov": {{ panorama.vaov }},
                    "minPitch": {{ panorama.min_pitch }},
                    "maxPitch": {{ panorama.max_pitch }},
                    "minYaw": {{ panorama.min_yaw }},
                    "maxYaw": {{ panorama.max_yaw }},
                    "minHfov": {{ panorama.min_Hfov }},
                    "maxHfov": {{ panorama.max_Hfov }},
                    "hotSpots": [
                        {% for hotspot in panorama.hotspots.all %}
                        {
                            "pitch": {{ hotspot.pitch }},
                            "yaw": {{ hotspot.yaw }},
                            "type": "info",
                            "text": `
                                <div class="hotspot-tooltip">
                                    <h3>{{ hotspot.title|escapejs }}</h3>
                                    <p>{{ hotspot.description|escapejs }}</p>
                                    {% if hotspot.image %}
                                    <img src="{{ hotspot.image.url }}" alt="{{ hotspot.title|escapejs }}">
                                    {% endif %}
                                    {% if hotspot.target_panorama %}
                                    <div class="hotspot-link">Подробнее →</div>
                                    {% endif %}
                                </div>
                            `,
                            "cssClass": "custom-hotspot",
                            {% if hotspot.target_panorama %}
                            "sceneId": "scene_{{ hotspot.target_panorama.id }}"
                            {% endif %}
                        }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]
                }
                {% for hotspot in panorama.hotspots.all %}
                    {% if hotspot.target_panorama %}
                        ,
                        "scene_{{ hotspot.target_panorama.id }}": {
                            "type": "equirectangular",
                            "panorama": "{{ hotspot.target_panorama.image.url }}",
                            
                            // Добавляем параметры из целевой панорамы
                            "haov": {{ hotspot.target_panorama.haov }},
                            "vaov": {{ hotspot.target_panorama.vaov }},
                            "minPitch": {{ hotspot.target_panorama.min_pitch }},
                            "maxPitch": {{ hotspot.target_panorama.max_pitch }},
                            "minYaw": {{ hotspot.target_panorama.min_yaw }},
                            "maxYaw": {{ hotspot.target_panorama.max_yaw }},
                            "minHfov": {{ hotspot.target_panorama.min_Hfov }},
                            "maxHfov": {{ hotspot.target_panorama.max_Hfov }},
                            "showControls": true,
                            "compass": true,
                            
                            "hotSpots": [
                                {
                                    "pitch": {{ hotspot.target_pitch|default:hotspot.pitch }},
                                    "yaw": {{ hotspot.target_yaw|default:hotspot.yaw }},
                                    "type": "info",
                                    "text": `
                                        <div class="hotspot-tooltip">
                                            <h3>{{ hotspot.target_panorama.title|escapejs }}</h3>
                                            <p>{{ hotspot.target_panorama.monument.description|escapejs }}</p>
                                            <div class="hotspot-link">← Назад</div>
                                        </div>
                                    `,
                                    "cssClass": "custom-hotspot",
                                    "sceneId": "main"
                                }
                            ]
                        }
                    {% endif %}
                {% endfor %}
            };
        
            viewer = pannellum.viewer('panorama-container', {
                "default": {
                    "firstScene": "main",
                    "sceneFadeDuration": 1000
                },
                "scenes": scenes
            });
        
            document.getElementById('back-button').addEventListener('click', () => {
                viewer.loadScene("main");
            });
        
            viewer.on('scenechange', function(newSceneId) {
                document.getElementById('back-button').style.display = 
                    (newSceneId === 'main') ? 'none' : 'block';
            });
        });
        </script>
</body>
</html>